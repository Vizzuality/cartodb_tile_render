<!DOCTYPE html>
<html>
    <head>
        <title>Google Maps JavaScript API v3 Example: Map Coordinates</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <meta charset="UTF-8">
        <style>
            html, body,#map_canvas {
                width: 100%;
                height: 100%;
                border: 0;
                padding: 0;
                margin: 0;
            } 
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
        <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"> </script>
        <script type="text/javascript" src="gmaps_mercator.js"> </script>
        <script type="text/javascript" src="canvas_tile_layer.js"> </script>
        <script type="text/javascript">

            var map;
            var chicago = new google.maps.LatLng(41.701504, -4.8300523);

            function createInfoWindowContent() {
                var numTiles = 1 << map.getZoom();
                var projection = new MercatorProjection();
                var worldCoordinate = projection.fromLatLngToPoint(chicago);
                var pixelCoordinate = new google.maps.Point(
                        worldCoordinate.x * numTiles,
                        worldCoordinate.y * numTiles);
                var tileCoordinate = projection.latLngToTile(chicago, map.getZoom());

                return ['Chicago, IL',
                       'LatLng: ' + chicago.lat() + ' , ' + chicago.lng(),
                       'World Coordinate: ' + worldCoordinate.x + ' , ' +
                           worldCoordinate.y,
                       'Pixel Coordinate: ' + Math.floor(pixelCoordinate.x) + ' , ' +
                           Math.floor(pixelCoordinate.y),
                       'Tile Coordinate: ' + tileCoordinate.x + ' , ' +
                           tileCoordinate.y + ' at Zoom Level: ' + map.getZoom()
                           ].join('<br>');
            }

function CartoDB(user) {
    this.base_url = 'http://' + user + ".cartodb.com/api/v1/sql"
}

CartoDB.prototype.sql = function(sql, callback) {
    $.getJSON(this.base_url  + "?q=" + encodeURIComponent(sql) + "&format=geojson&callback=?", callback);
}

CartoDB.prototype.tile_data = function(x, y, zoom , callback) {
    var projection = new MercatorProjection();
    var bbox = projection.tileBBox(x, y, zoom);
    var sql = "select the_geom,ele from track_points_1 WHERE the_geom && ST_SetSRID(ST_MakeBox2D("
    sql += "ST_Point(" + bbox[0].lng() + "," + bbox[0].lat() +"),"
    sql += "ST_Point(" + bbox[1].lng() + "," + bbox[1].lat() +")), 4326)"
    this.sql(sql, callback);
}


//micro tmp from thomas fuchs
function t(s,d){
 for(var p in d)
   s=s.replace(new RegExp('{'+p+'}','g'), d[p]);
 return s;
}


function initialize() {
    var mapOptions = {
      zoom: 13,
      center: chicago,
    
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    map = new google.maps.Map(document.getElementById('map_canvas'),
            mapOptions);

    var cartodb = new CartoDB('javi');
    var projection = new MercatorProjection();
    var coordInfoWindow = new google.maps.InfoWindow();
    coordInfoWindow.setContent(createInfoWindowContent());
    coordInfoWindow.setPosition(chicago);
    coordInfoWindow.open(map);
    function apply_style(ctx, data) {
        var c = 255.0*(data.ele - 870)/(910.0 - 870.0);
        console.log(data.ele);
        ctx.fillStyle = "rgb(" +c+","+c+","+c+")";
    }
    var layer = new CanvasTileLayer(function(tile_info, coord, zoom) {
          var radius = 2;
          var ctx = tile_info.ctx;
          cartodb.tile_data(coord.x, coord.y, zoom, function(data) {
            var tile_point = projection.tilePoint(coord.x, coord.y, zoom);
            if(data.features.length) {
                  var points = data.features;
                  for(var i = 0; i < points.length; ++i) {
                      var latlng = points[i].geometry.coordinates;
                      latlng = new google.maps.LatLng(latlng[1], latlng[0]);
                      var p = projection.latLngToTilePoint(latlng, zoom);
                      apply_style(ctx, points[i].properties);
                      ctx.save();
                      ctx.translate(p.x, p.y);
                      ctx.beginPath();
                      ctx.arc(radius, radius, radius, 0, Math.PI * 2, true);
                      ctx.closePath();
                      ctx.fill();
                      ctx.restore();
                   }
            }
          });

    });
    map.overlayMapTypes.insertAt(0, layer);

    google.maps.event.addListener(map, 'zoom_changed', function() {
            coordInfoWindow.setContent(createInfoWindowContent());
            coordInfoWindow.open(map);
            });
}

//https://javi.cartodb.com/api/v1/sql?q=select%20the_geom,%20ele%20from%20track_points_1&format=geojson
google.maps.event.addDomListener(window, 'load', initialize);
</script>
</head>
<body>
    <div id="map_canvas">
    </div>
</body>
</html>
